---
import { getI18n } from "../../i18n";
import timelineES from "../../content/timeline/es";
import timelineEN from "../../content/timeline/en";

import ProjectModal from "../shared/ProjectModal.astro";

const { currentLocale } = Astro;
const i18n = getI18n({ currentLocale });

const timelineData = currentLocale === "es" ? timelineES : timelineEN;

function getDescription(item: any) {
  return (item.description || "").replace(/\{color\}/g, item.color || "");
}
---

<section
  id="timeline"
  class="flex flex-col w-full justify-center items-center h-auto scroll-mt-[150px] sm:scroll-mt-0"
>
  <script>
    document.addEventListener("astro:page-load", () => {
      document.querySelectorAll(".ver-more").forEach((btn) => {
        btn.addEventListener("click", () => {
          const idx = Number(btn.getAttribute("data-index"));
          if (Number.isNaN(idx)) return;
          const projectsEl = document.getElementById(`projects-${idx}`);
          const cards = document.querySelectorAll(".card");
          const card = cards && cards.length > idx ? cards[idx] : null;
          const h3 = card ? card.querySelector("h3") : null;
          const title = h3 ? h3.textContent || "" : "";
          const html = projectsEl
            ? projectsEl.innerHTML
            : document.documentElement.lang === "en"
              ? "No projects available."
              : "No hay proyectos.";
          window.dispatchEvent(
            new CustomEvent("open-projects-modal", { detail: { title, html } })
          );
        });
      });
    });
  </script>
  <div
    class="absolute left-0 bottom-0 h-full w-full flex items-end pointer-events-none z-0"
  >
    <div class="w-28 h-28 overflow-auto flex rounded-xl relative blur-2xl">
      <span
        class="absolute w-16 h-16 -top-1 -right-1 bg-green-500 rounded-md rotate-45"
      ></span>
      <span
        class="absolute w-16 h-16 -bottom-1 -right-1 bg-[#FCDC58] rounded-md rotate-45"
      ></span>
    </div>
  </div>
  <h2 class="text-3xl font-bold text-center mb-8">{i18n.trayectory.title}</h2>
  <div id="topTimeLine" class="relative flex justify-center">
    <div id="line1" class="timeline-line absolute w-1 top-0 transition-all">
    </div>

    <div class="space-y-12">
      {
        timelineData.map((item, index) => (
          <div
            data-index={index}
            class={`relative flex items-center justify-center ${index % 2 === 0 ? "lg:justify-start" : "lg:justify-end"}`}
          >
            <div
              id={`dot-${index}`}
              class="absolute w-6 h-6 bg-white border-4 rounded-full z-10 dot"
              style={`border-color: ${item.color}; left: 50%; transform: translateX(-50%); opacity: 0;`}
            />
            <div
              class={`w-[90%] lg:w-4/12 p-6 bg-box-bg shadow-md rounded-lg transition-transform duration-1000 ease-out opacity-0 card ${index % 2 === 0 ? "from-left lg:ml-40 ml-0" : "from-right lg:mr-40 mr-0"}`}
              style={`border-left: 4px solid ${item.color};`}
            >
              <h3 class="text-xl font-semibold" style={`color: ${item.color}`}>
                {item.title}
              </h3>
              <p class="text-sm text-heading-3">{item.date}</p>
              <p
                class="mt-2 text-heading-1"
                id={`desc-${index}`}
                set:html={getDescription(item)}
              />
              <div class="mt-4 flex justify-end">
                <button
                  class="ver-more text-white font-semibold px-3 py-1 rounded-md hover:opacity-90"
                  style={`background-color: ${item.color};`}
                  data-index={index}
                >
                  {currentLocale === "es" ? "Ver m√°s" : "See more"}
                </button>
              </div>

              <div
                id={`projects-${index}`}
                class="hidden projects-hidden"
                aria-hidden="true"
              >
                {item.projects &&
                  item.projects.map((p) => (
                    <div class="project-item mb-4">
                      <h4 class="text-lg font-semibold">{p.title}</h4>
                      {p.description && (
                        <p
                          class="mt-1 text-sm text-heading-3 project-summary"
                          set:html={p.description}
                        />
                      )}
                      <ul class="list-disc ml-5 mt-2 space-y-1">
                        {p.bullets && p.bullets.map((b) => <li set:html={b} />)}
                      </ul>
                    </div>
                  ))}
              </div>
            </div>
          </div>
        ))
      }
    </div>
  </div>
  <div id="current" class="text-xl font-semibold mt-12 text-center">
    {i18n.trayectory.actuality}
  </div>
</section>

<ProjectModal />

<style>
  .timeline-line {
    background: linear-gradient(to bottom, #4f46e5, #10b981, #f59e0b);
    height: 0%;
    transition: height 1s ease-out;
    position: absolute;
    top: 0;
    border-radius: 5px;
  }

  .timeline-line.active {
    height: 50%;
  }

  .dot-visible {
    opacity: 1 !important;
    transform: scale(1);
    transition:
      opacity 1s ease-out,
      transform 1s ease-out;
  }

  .card.visible {
    opacity: 1;
    transform: translateX(0);
  }

  .from-left {
    transform: translateX(-100vw);
  }

  .from-right {
    transform: translateX(100vw);
  }

  #timeline div:hover {
    transform: translateY(-4px);
    transition: transform 0.3s ease;
  }

  #current {
    opacity: 0;
    transition: opacity 2s ease-out;
  }

  :global(#timeline a) {
    text-decoration: none;
    font-weight: bold;
  }

  :global(#timeline a:hover) {
    text-decoration: underline;
  }

  .project-summary {
    font-size: 1.08rem;
    font-weight: 600;
    margin-top: 6px;
    margin-bottom: 6px;
    color: rgb(var(--heading-3));
  }

  .projects-hidden ul li {
    font-size: 0.95rem;
    line-height: 1.45;
    margin-bottom: 6px;
  }

  .projects-hidden ul li::marker {
    color: rgba(79, 70, 229, 0.9);
  }

  .project-summary {
    font-size: 1.05rem;
    font-weight: 600;
    margin-top: 6px;
    margin-bottom: 6px;
  }

  .projects-hidden ul li {
    font-size: 0.95rem;
    line-height: 1.4;
  }

  @media (max-width: 1025px) {
    .dot {
      opacity: 0 !important;
    }
  }
</style>

<script
  type="application/json"
  id="timeline-data"
  set:html={JSON.stringify(timelineData).replace(/</g, "\\u003c")}
/>

<script>
  document.addEventListener("astro:page-load", () => {
    const timelineDataEl = document.getElementById("timeline-data");
    const timelineData = timelineDataEl
      ? JSON.parse(timelineDataEl.textContent)
      : [];

    let isAnimating = false;
    document.addEventListener("scroll", () => {
      const cards = document.querySelectorAll(".card");
      const dots = document.querySelectorAll(
        ".timeline-line + div > .relative .absolute"
      );
      const lines = document.querySelectorAll(".timeline-line");
      const windowHeight = window.innerHeight;
      const getTimelineTop = document.getElementById("timeline");

      if (getTimelineTop === null) return;
      const timelineTop = getTimelineTop.getBoundingClientRect().top;

      if (timelineTop < windowHeight - 100 && !isAnimating) {
        isAnimating = true;
        let delay = 0;
        let val = 0;

        function animateTimeline() {
          const line = lines[0] as HTMLElement | undefined;
          if (!line) return;
          timelineData.forEach((item: any, index: any) => {
            setTimeout(() => {
              const dot = document.getElementById(
                `dot-${index}`
              ) as HTMLElement | null;
              const card = (cards[index] as HTMLElement) || null;

              val += animateLineToDot(index, val);

              const gradient = getGradient(index);
              (line as HTMLElement).style.background = gradient;

              (line as HTMLElement).style.height = `${val}%`;

              setTimeout(() => {
                if (dot) dot.classList.add("dot-visible");
                if (card) card.classList.add("visible");
              }, 500);
            }, delay);

            delay += 2000;
          });
          setTimeout(() => {
            val += animateLineToDot(timelineData.length + 1, val);
            const gradient = getGradient(timelineData.length + 1);
            (line as HTMLElement).style.background = gradient;

            (line as HTMLElement).style.height = `${val}%`;
            const cur = document.getElementById("current");
            if (cur) (cur as HTMLElement).style.opacity = "1";
          }, delay);
        }

        animateTimeline();
      }
    });

    function getGradient(index: any) {
      const colors = timelineData.map((item: any) => item.color);
      if (index === 0) {
        return `linear-gradient(to bottom, ${colors[0]}, ${colors[0]})`;
      } else if (index === 1) {
        return `linear-gradient(to bottom, ${colors[0]}, ${colors[1]})`;
      } else if (index === 2) {
        return `linear-gradient(to bottom, ${colors[0]}, ${colors[1]}, ${colors[2]})`;
      } else {
        return `linear-gradient(to bottom, ${colors[0]}, ${colors[1]}, ${colors[2]})`;
      }
    }

    function animateLineToDot(index: any, val: any) {
      let dot1 = null;
      let dot2 = null;
      if (index === 0) {
        dot1 = document.getElementById(`dot-${index}`);
      } else {
        dot1 = document.getElementById(`dot-${index - 1}`);
        dot2 = document.getElementById(`dot-${index}`);
      }
      const timeline = document.getElementById("topTimeLine");
      if (!timeline) return 0;
      if (index === 0) {
        if (!dot1) return 0;
        const timelineRect = timeline.getBoundingClientRect();
        const dotPosition1 =
          dot1.getBoundingClientRect().top - timelineRect.top;
        const timelineHeight = timelineRect.height || 1;
        return (dotPosition1 / timelineHeight) * 100;
      } else if (dot2) {
        if (!dot1 || !dot2) return 0;
        const dotPosition1 = dot1.getBoundingClientRect().top;
        const dotPosition2 = dot2.getBoundingClientRect().top;
        const timelineHeight = timeline.getBoundingClientRect().height || 1;
        const distance = dotPosition2 - dotPosition1;
        return (distance / timelineHeight) * 100;
      }

      return 102 - val;
    }
  });
</script>
